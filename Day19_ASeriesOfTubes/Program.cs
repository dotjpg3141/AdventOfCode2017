using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Day19_ASeriesOfTubes
{
	class Program
	{
		static void Main(string[] args)
		{
			var example = ParseInput("     |          \r\n     |  +--+    \r\n     A  |  C    \r\n F---|----E|--+ \r\n     |  |  |  D \r\n     +B-+  +--+ \r\n                \r\n");
			var input = ParseInput("                                                           |                                                                                                                                             \r\n                                       +-----------------------------------+       +-+         +-------------------------------------------------------------------------------------------+   +-+       \r\n                                       |                   |               |       | |         |                                                                                           |   | |       \r\n                                       +-----------------+ |       +-----+ | +-----+ |         |                                             +---------------------------------------------|---+ |       \r\n                                                         | |       |     | | |       |         |                                             |                                             |     |       \r\n                                                         +-------------+ +-+ |       |         | +---------------+                           |                                             |     |       \r\n                                                           |       |   |     |       |         | |               |                           |                                             |     |       \r\n               +---------------------------------------------------------------------|---------|-----------+     |                           |                       +---------------------|-----+       \r\n               |                                           |       |   |     |       |         | |         |     |                           |                       |                     |             \r\n               |                                           |       +-----+ +-------------------+ +-+       +-------------------------------------------------------------------------------------------+ \r\n               |                                           |           | | | |       |             |             |                           |                       |                     |           | \r\n               |                                   +-------|-------+   | +-|-+   +---|-------------------------------------------------------|---------------------------------------------|---+       | \r\n               |                                   |       |       |   |   |     |   |             |             |                           |                       |                     |   |       | \r\n               |                                   |       |       |   | +-|-----|---------+       +-----------------------------------------------------------------|-------------------------|---+   | \r\n               |                                   |       |       |   | | |     |   |     |                     |                           |                       |                     |   |   |   | \r\n               |                     +-----------------------------|---|---|-----|---|-------------------------------------------+           |   +-------------------|-------------------------+ +-+   | \r\n               |                     |             |       |       |   | | |     |   |     |                     |               |           |   |                   |                     |     |     | \r\n               |     +---------------|-------------|-------|-------------|-----------|-----|-------------------------------------|-----------------------------------|---------------------------+ +-+ | \r\n               |     |               |             |       |       |   | | |     |   |     |                     |               |           |   |                   |                     |       | | | \r\n               |     |               |             |       |       |   | | |     |   |     |                     |               |           |   |               +---|---+             +-----------+ +-+ \r\n               |     |               |             |       |       |   | | |     |   |     |                     |               |           |   |               |   |   |             |   |             \r\n               |     | +-------------|---------------------|-------|-----|-----------|-----|---------------------|---------------|---------------|-------+       |   |   |             |   |             \r\n               |     | |             |             |       |       |   | | |     |   |     |                     |               |           |   |       |       |   |   |             |   |             \r\n               | +---|-|---------------------------|---------------|---+ | |     +---|-----|-----------------+   |               |       +---|-------------+     |   |   |             |   | +-+         \r\n               | |   | |             |             |       |       |     | |         |     |                 |   |               |       |   |   |       | |     |   |   |             |   | | |         \r\n               | |   | |             |             |       |       |     | |         |     |                 | +-------------------+     +-+ |   +-----------------------------------+ |   | | |         \r\n               | |   | |             |             |       |       |     | |         |     |                 | | |               | |       | |           | |     |   |   |           | |   | | |         \r\n               | |   +---------------|-------------|---------------|-------|---------|-----|-+               | | |               | |       | |           | | +-----------|-------------+   | | |         \r\n               | |     |             |             |       |       |     | |         |     | |               | | |               | P       | |           | | |   |   |   |           |     | | |         \r\n               | |     |             |             |       |       |     | |       +-|-------------------------|-|---------------|-|---------|-----------|-------|-------|-----------+     | +-------+   \r\n               | |     |             |             |       |       |     | |       | |     | |               | | |               | |       | |           | | |   |   |   |                 |   |     |   \r\n +-------------+ |     |             |           +---------|---------------|-------|-|-----|-----------------|-|-|---+           | |       | |           | | |   |   |   |             +-----+ |     +-+ \r\n |               |     |             |           | |       |       |     | |       | |     | |               | | |   |           | |       | |           | | |   |   |   |             |   | | |       | \r\n +-----+         |     |             |           | |       |       |     | +---------------|-----------------|-|-|-------------------------------------------|---|---|---------------------|-------+   | \r\n       |         |     |             |           | |       |       |     |         | |     | |               | | |   |           | |       | |           | | |   |   |   |             |   | | |   |   | \r\n       |         |     |             |     +---------------|-------------|---------|-|-----|-------+         | | |   |           | |     +---|-------------+ |   |   |   |             |   | +-+   |   | \r\n       |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | |     | | |           |   |   |   |   |             |   |       |   | \r\n       |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | |     | | |           +-------|---------------------|---|-+   +---+ | \r\n       |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | |     | | |               |   |   |   |             |   | |   | | | | \r\n       |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | |     | | |               |   |   |   |   +---------|---|-+   | | | | \r\n       |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | |     | | |               |   |   |   |   |         |   |     | | | | \r\n +---------------------|-------------|-----|-----|-|-------|-------|---------------|-|-----|-|-----|---------|---|---|-------------|-+   | | |               |   +---|---|-------------|-----+   | | | | \r\n |     |         |     |             |     |     | |       |       |     |         | |     | |     |         | | |   |           | | |   | | |               |       |   |   |         |   | |   | | | | \r\n |     +---------+     |             |     |     | |   +---|-+     |     |         | |     | |     |         | | |   |           | | |   | | |     +---------|---+   |   +---|-+       |   | |   | | | | \r\n |                     |             |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   | | |     |         |   |   |       | |       |   | |   | | | | \r\n |     +-----------------+           |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   | | |     |         |   |   |       | |       |   | |   | | | | \r\n |     |               | |           |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   | | |     |         |   |   |       | |       |   | |   | | | | \r\n |     |               | +-----------|-----|-----|-----|---|-|-----|---------------|-------|-|-----------------------|---------------------+ |     |         |   |   |       | |       |   | |   | | | | \r\n |     |               |             |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   |   |     |         |   |   |       | |       |   | |   | | | | \r\n |     |     +-+       |             |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   |   |     |         |   |   |   +---|-|-----------|-----+ | | | \r\n |     |     | |       |             |     |     | |   |   | |     |     |         | |     | |     |         | | |   |           | | |   |   |     |         |   |   |   |   | |       |   | |     | | | \r\n |     |     | |     +---+           |     |     | |   |   | |     +-----+         | |   +-|-+   +-------------|-|---|-----------|-------|---|---+ |         |   |   |   | +-+ |       |   | +---------+ \r\n |     |     | |     | | |           |     |     | |   |   | |                     | |   | |     | |         | | |   |           | | |   |   |   | |         |   |   |   | |   |       |   |       | |   \r\n |     |     | |     | | |           |     |   +-|-|---|---|-|---------------------|-----|-|---------------------|-----------------|-----|---------+         |   |   |   | |   |       |   |       | |   \r\n |     |     | |     | | |           |     |   | | |   |   | |                     | |   | |     | |         | | |   |           | | |   |   |   |           |   |   |   | |   |       |   |       | |   \r\n |     |     | |     | | |           |     +---+ | |   |   | |                     | |   | |     | |         | | |   |           | | | +-|-------------------|-----------|-+   |       |   |       | |   \r\n |     |     | |     | | |           |           | |   |   | |                     | |   | |     | |         | | |   |           | | | | |   |   |           |   |   |   |     |       |   |       | |   \r\n |     |     | |     | | |           |           | |   |   | |                     | |   | |     | |         | | |   |           | | | | |   | +-----------------|-------|-----------+ |   |       | |   \r\n |     |     | |     | | |           |           | |   |   | |                     | |   | |     | |         | | |   |           | | | | |   | | |           |   |   |   |     |     | |   |       | |   \r\n |     |     | |     | | +-----------|-----------------|---|-|-------------+       | |   | |     | |         | | |   |           | | | | |   | | |           |   |   |   |     |     | |   |       | |   \r\n |     |     | |     | |             |           | |   |   | |             |       | |   | |     | |         | | |   |           | | | | |   | | |           |   |   |   |     |     | |   |       | |   \r\n |     |     | |     | |             |           | |   |   | |             |       | |   | |     | | +-------|-|-|---|-----------------|---------|---------------|-+ |   |     |     | |   |       | |   \r\n |     |     | |     | |             |           | |   |   | |             |       | |   | |     | | |       | | |   |           | | | | |   | | |           |   | | |   |     |     | |   |       | |   \r\n |     |     | |     | |             |           | |   |   | |             |       | |   | |     | | |       | | +---|-------------|---|-|---|---------------|---|-|-----+     |     | |   |       | |   \r\n |     |     | |     | |             |           | |   |   | |             |       | |   | |     | | |       | |     |           | | | | |   | | |           |   | | |         |     | |   |       | |   \r\n |     |     | |     +---------------|-----------|-----|-+ | |             |       | |   | |     | | |       | |   +-|-----------|-------|---|-|-+           |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | | | |             |       | |   | |     | | |       | |   | |           | | | | |   | |             |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | | | |             |       | |   | |     | | |       | |   | |           | | | | |   | |             |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | | | |             |       | |   | |     | | |       | |   | |           | | | | |   | |             |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | | | |             |       | |   | |     | | |       | |   | |           | | | | |   | |             |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | | | |             |       | |   | |     | | |       | |   | |           | | | | |   | |             |   | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   | +---|-------------------------+ | +-----|-----------|-------|-----------|-|-|-------|---------------|-+ | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   |   | |             |       | | | |       | | |       | |   | |           | | | | |   | |             | | | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   |   | |             |       | | | |       +-------------|---|-------------|-|---|-|---------+         | | | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   |   | |             |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   |   | |             |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   |       | |   \r\n |     |     | |       |             |           | |   |   | |             |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   |       | |   \r\n |     |     | |     +---------------|-------------|---|-----+     +-------|-------|-----|---------|-----------|---|-|-------------|-|-|-|-----|-------------|-|-|-|-----------|-----|-------+     | |   \r\n |     |     | |     | |             |           | |   |   |       |       |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | +---|-+   | |     | |             |           | |   |   |       |       |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | |   | |   | |     | |             |           | |   |   |       |       |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | | +---|-----|-----|-----------------+         | |   | +---------|-+     |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | |         | |   | | |       | |     |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | |         | |   | | |       | |     |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | |         | |   | | |       | |     |       | | | |         | |       | |   | |           | | | | |   | |   |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | |         | +-+ | | |       | |     +-----+ | | | |         | |       | |   | |           | | | +-|-+ | +-+ |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | |         |   | | | |       | |           | | | | |         | |       | |   | |           | | |   | | |   | |         | | | | |         |     | |   | |     | |   \r\n | | | | |   | |     | |             | | +-------|-------------------|-----------|---|------------Y--|-------------|---------------|-----|---|-----|---------|---|-----------+ |     | |   | |     | |   \r\n | | | | X   | |     | |             | | |       |   | | | |       | |           | | | | |         | |       | |   | |           | | |   | | |   | |         | | | | |       | |     | |   | |     | |   \r\n | | | | |   | |     | |             | | |       |   | | | |       | |           | | | | | +---------|---------------------------------------|-----|-----------|---|---------|-|-----------+ |     | |   \r\n | | | | |   | |     | |             | | |       |   | | | |       | |           | | | | | |       | |       | |   | |           | | |   | | |   | |         | | | | |       | |     | |     |     | |   \r\n | | | | |   | |     | |             | | |       |   | | | |       | |           | | | | | |       | |       | |   | |           | | |   | | |   | |         | | | | |       | |     | |     |     | +-+ \r\n | | | | |   | |     | |             | | |       |   | | | |       | |           | | | | | |       | |       | |   | |           | | |   | | |   | |         | | | | |       | |     | |     |     |   | \r\n | | | | |   | |     +-|-------------------------|-----|-----------|-|-----------|---|-------------|---------|-|---|-|-----------|---------|-|---------------------|-|---------|-------|-----------|-+ | \r\n | | | | |   | |       |             | | |       |   | | | |       | |           | | | | | |       | |       | |   | |           | | |   | | |   | |         | | | | |       | |     | |     |     | | | \r\n | | | | |   | |       |             | | |       |   | +-|---------|-------------|-|-|-------------|---------|-|-----------------|-------+ | |   | |         | | | | |       | |     | |     |     | | | \r\n | | | | |   | |       |             | | |       |   |   | |       | |           | | | | | |       | |       | |   | |           | | |     | |   | |         | | | | |       | |     | |     |     | | | \r\n | +-----------|-----------------------|-|---+   | +---------------|-------------|---|-|-+ |       | |       | |   | |   +-------|---|-----|-|-+ | |         | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           | | | |   |       | |       | |   | |   |       | | |     | | | | |         | | | | |       | |     | |     O     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           | +-|-----|-----------------|-|---|-+   |       | | |     | | | | |         | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           |   | |   |       | |       | |   |     |       | | |     | | | | |         | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           |   | |   +---------|-------|-|---|-----------------------|-|-|-|---+       | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | R |   | |       | |           |   | |           | |       | |   |     |       | | |     | | | | | |       | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           |   | |           | |       | |   |     |       | | |     | | | | | |       | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | |   | |       | |           |   | |           | |       | |   |     |       | | |     | | | | | |       | | | | |       | |     | |     |     | | | \r\n |   | | |   | |       |             | | |   |   | | | +-|---------|-|---------------|-------------|-+       | |   |     |       | | | +-----|-|-|-|-|-------|-|-|-----------|-|-----|-|---+ |     | | | \r\n |   | | |   | |       |             | | |   |   | | | | | |       | |           |   | |           |         | |   |     |       | | | |   | | | | | |       | | | | |       | |     | |   | |     | | | \r\n |   | | |   | |       |             | | |   +---|-|---+ | +---------|-----------|-----------------|---------|-----------------------|-----|-+ | | | | +---------|---|---+   | |     | |   | |     | | | \r\n |   | | |   | |       |             | | |       | | |   |         | |           |   | |           |         | |   |     |       | | | |   |   | | | | |     | | | | |   |   | |     | |   | |     | | | \r\n |   | | |   | |       |             | | |       | +-----|---------|-|---------------|-------------|-----------|---|-----|-----------|---------|-|---+ +-+   +-----|-|---------------+ |   | |     | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |           W         | |   |     |       | | | |   |   | | |     |     | | | |   |   | |       |   | |     | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |           |         | |   |     |   +---|-----|-------|---|---+ |   +-|-|---|-------|-|-------|-----|-+   | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |           |         | |   |     |   |   | | | |   |   | | |   | |   | | | | |   |   | |       |   | | |   | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |   +-------+         | |   |     |   |   | | +-|---------------------|---|-|-|---|-+ | |       |   | | |   | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |   |                 | |   |     |   |   | |   |   |   | | |   | |   | | | | |   | | | |       |   | | |   | | | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |   |                 | |   |     |   |   | |   |   |   | | | +-------------|-|---|---|-|-------+   | | +-----+ | \r\n |   | | |   | |       |             | | |       |   |   |         | |           |   | |   |                 | |   |     |   |   | |   |   |   | | | | | |   | | | | |   | | | |           | |     |   | \r\n |   | | |   | |       |             | | |     +-|-------|---------|-+           | +---+   |                 | | +-|-----|---------+ +-|-------------+ | |   | | | | |   | | | |           | |     |   | \r\n |   | | |   | |       |             | | |     | |   |   |         |             | | |     |                 | | | |     |   |   |   | |   |   | | |   | |   | | | | |   | | | |           | |     |   | \r\n |   | | | +-|-|-------|---------------|-------|-|-----------------|-------------|---|-----|-----------------|-|-|-|-----|-----------|-----|---|---|---|-|-----------|-----|-|-------------------------+ \r\n |   | | | | | |       |             | | |     | |   |   |         |             | | |     |                 | | | |     |   |   |   | |   |   | | |   | |   | | | | |   | | | |           | |     |     \r\n |   | | | +-------+   |             | | |   +-+ +-------|---------|-------------|---|-----------------------|-----|-----|-------|---|-----|-----|---+ | | +---|-+ | |   | | | |           | | +-------+ \r\n |   | | |   | |   |   |             | | |   |       |   |         |             | | |     |                 | | | |     |   |   |   | |   |   | | | | | | | | |   | |   | | | |           | | |   |   | \r\n |   | | |   | |   |   |             | +-----|-------|---+         |             | | |     |       +---+     | | | |     |   |   +---|-|---|-------|---|-----|-|---|---------|-----------+ | | |   |   | \r\n |   | | |   | |   |   |             |   |   |       |             |             | | |     |       |   |     | | | |     |   |       | |   |   | | | | | | | | |   | |   | | | |         | | | |   |   | \r\n |   | | |   | |   |   |             |   |   |       |             |             | | |     |     +-|-------------|-----------|---------------+ +-|-----|-+ +---|-----|---|-|-------------|---|-+   |   | \r\n |   | | |   | |   |   |             |   |   |       |             |             | | |     |     | |   |     | | | |     |   |       | |   | |   | | | |     | |   | |   | | | |         | | |     |   | \r\n |   | | |   +---------|-------------|-----------------------------------------------|-----|-------|---|-----|-----------|---|-------|-----|-|---|---+ |     | | +-|-|---|---|---------------|-+   |   | \r\n |   | | |     |   |   |             |   |   |       |             |             | | |     |     | |   |     | | | |     |   |       | |   | |   | |   |     | | | | |   | | | |         | | | |   |   | \r\n |   | | |     |   |   |             |   |   |       |   +-----------------------|-|-|-----------------------|---|-|-----|-----------|-|-----------------------|-|-------+ | | |   +-----|---|-|---|---+ \r\n |   | | |     |   |   |             |   |   |       |   |         |             | | |     |     | |   |     | | | |     |   |       | |   | |   | |   |     | | | | |     | | |   |     | | | |   |     \r\n |   | | |     |   |   |             |   |   |       |   +---+     |             | +-|-------------+   |     | | | |     |   | +-----+ |   | |   | |   |     | | | | |     | | |   |     | | | |   |     \r\n |   | E |     |   |   |             |   |   |       |       |     |             |   |     |     |     |     | | | |     |   | |       |   | |   | |   |     | | | | |     | | |   |     | | | |   |     \r\n |   | | |     |   |   |             |   |   |       |       |     | +-----------+   |   +-+     |     |     | | | |     |   | |       |   | | +-+ |   |     | | | | |     | | |   | +---|---|-+   |     \r\n |   | | |     |   |   |             |   |   |       |       |     | |               |   |       |     |     | | | |     |   | |       |   | | |   |   |     | | | | |     | | |   | |   | | |     |     \r\n |   | | |     |   |   |             |   |   |       |       +-----------------------|---|-------|-----|-----------------------------------|-|---------------|-------|-----|---|---------|-|-----------+ \r\n |   | | |     |   |   |             |   |   |       |             | |               |   |       |     |     | | | |     |   | |       |   | | |   |   |     | | | | |     | | |   | |   | | |     |   | \r\n | +-|---------|---|---------------------|---|-------|-----------------------+       |   |     +-------------|---------+ |   | |       |   | | |   |   |     | | | | |     | | |   | |   | | |     |   | \r\n | | | | |     |   |   |             |   |   |       |             | |       |       |   |     | |     |     | | | |   | |   | |       |   | | |   |   |     | | | | |     | | |   | |   | | |     |   | \r\n | | | | |     |   |   |             |   |   |       |     +-----------+     |     +-----|-----|---+   |     +-|-------|-|-----------------|-|---------|-------|-|-------------------|---|-------+ | +-+ \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |     | | |   |       | | |   | |   | |       |   | | |   |   |     | | | | |     | | |   | |   | | |   | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |     | | |   |       | | |   | |   | |       +-------|---|---------|-|-|---------|-|-|-----|-----|-|-+ | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |     | | |   |       | | |   | |   | |           | | |   |   |     | | | | |     | | |   | |   | | | | | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |   +-----|-------------|-------------|-----------|-|-|---|---|---------|---|---------|---|-|-----+ | | | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |   | | | |   |       | | |   | |   | |           | | |   |   |     | | | | |     | | |   | |   |   | | | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |   | | | |   +-----------|-----|-----|---------+ | | |   |   |     | | | | |     | | |   | |   |   | | | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |     | |   |   | | | |           | | |   | |   | |         | | | |   |   |     | | | | |     | | |   | |   |   | | | | |   \r\n | | | | | +-----------------------------------------------|-------|---|-----|-----------------------+         | | |   | |   | |         | | | |   |   |     | | | | |     | | |   | |   |   | | | | |   \r\n | | | | | |   |   |   |             |   |   |       |     |       | | |     |     | |   |   | | | | |         | | |   | |   | |         | | | |   |   |     | | | | |     | | |   | |   |   | | | | |   \r\n | | | | | +-------------------------------------------------------|-|-------|---+ | |   | +-|-----|-------------|-|---|-|---|---------------|-|---|---|-------------|-+   | | |   | |   |   | | | | |   \r\n | | | | |     |   |   |             |   |   |       |     |       | | |     |   | | |   | | | | | | |         | | |   | |   | |         | | | |   |   |     | | | | | |   | | |   | |   |   | | | | |   \r\n | | | | |     |   |   |             |   |   |       |   +-|-----------|-----------|-----|---+ | | | |         | | |   +-----|-|-----------+ | |   |   |     | | | | | |   | | |   | |   |   | | | | |   \r\n | | | | |     |   |   |             |   |   |       |   | |       | | |     |   | | |   | |   | | | |         | | |     |   | |         |   | |   |   |     | | | | | |   | | |   | |   |   | | | | |   \r\n | +---|---------------------------------|---|-+ +---|---|-|-------|-|-----------|-|-|--H--------|---|-------------------|---|-|-----------------------+     | | | | | |   | | |   | |   |   | | | | |   \r\n |   | | |     |   |   |             |   |   | | |   |   | |       | | |     |   | | |   | |   | | | |         | | |     |   | |         |   | |   |         | | | | | |   | | |   | |   |   | | | | |   \r\n |   | | |     |   |   |             | +-----|-|-|-------|-|---------|-|---------|---|---|-------|---|-------------|-----|-------------------|-----|---------|-|-------|-----|-----+ |   |   | +-|---+   \r\n |   | | |     |   |   |             | | |   | | |   |   | |       | | |     |   | | |   | |   | | | |         | | |     |   | |         |   | |   |         | | | | | |   | | |     |   |   |   | |     \r\n |   | | |     |   |   |             | | |   | | |   |   | |       | | |     |   | | |   | |   | | | |         | +-------------+         |   | |   |   +-+   | | | | +-|---|-|-------|---|-------|-|-+   \r\n |   | | |     |   |   |             | | |   | | |   |   | |       | | |     |   | | |   | |   | | | |         |   |     |   |           |   | |   |   | |   | | | |   |   | | |     |   |   |   | | |   \r\n |   | | |     |   +---------------------|---|-|-----|-------------|-------------------------------|-|-------------|---------|---------------------------|---+ | | |   |   | | |     |   |   |   | | |   \r\n |   | | |     |       |             | | |   | | |   |   | |       | | |     |   | | |   | |   | | | |         |   |     |   |           |   | |   |   | |     | | |   |   | | |     |   |   |   | | |   \r\n |   | | |     |       |             | | |   | +-----|-----|-------|---|-----------------|-|---|---|-|-----------------------------------|---------|---|-------|---+   |   | | |     |   +-----+ | | |   \r\n |   | | |     |       |             | | |   |   |   |   | |       | | |     |   | | |   | |   | | | |         |   |     |   |           |   | |   |   | |     | |     |   | | |     |       | | | | |   \r\n |   | | |     |       |             | +-|---------------|-+       | | |     +-------|---|-----------|-----------+ |     |   |     +---------|-----|---|-------|-|-+   |   | | |     |       | | | | |   \r\n |   | | |     |       |             |   |   |   |   |   |         | | |         | | |   | |   | | | |         | | |     |   |     |     |   | |   |   | |     | | |   |   | | |     |       | | | | |   \r\n |   | | |     |       |             | +-------------|---|-------------+         | | |   | |   | | | |         | | |     |   |     |     |   | |   |   | |     | | |   |   | | |     |       | | | | |   \r\n |   | | |     |       |             | | |   |   |   |   |         | |           | | |   | |   | | | |         | | |     |   |     |     |   | |   |   | |     | | |   |   | | |     |       | | | | |   \r\n |   | | |     |       |   +---------|-|-|-------------------------|-----------------|---|-------|-|-------------|-|-----|---------|-----|---------|---|-------|-+ |   |   | | |     |       | | | | |   \r\n |   | | |     |       |   |         | | |   |   |   |   |         | |           | | |   | |   | | | |         | | |     |   |     |     |   | |   |   | |     |   |   |   | | |     |       | | | | |   \r\n | +-|-|-------|-------|-------------|-------|---+   |   |         | |   +-----------+   | |   | | | |         | | |     |   |     |     |   | |   |   | |     |   |   |   +-----+   |       | | | | |   \r\n | | | | |     |       |   |         | | |   |       |   |         | |   |       | |     | |   | | | |         | | |     |   |     |     |   | |   |   | |     |   |   |     | | |   |       | | | | |   \r\n | | | | |   +-|-----------+         | | |   |       |   |         | |   |       | +-+   | |   | | | |         | +-|-------+ |     |     | +-------|---------------|---------|---+   |       | | | | |   \r\n | | | | |   | |       |             | | |   |       |   |         | |   |       |   |   | |   | | | |         |   |     | | |     |     | | | |   |   | |     |   |   |     | |     |       | | | | |   \r\n | | | | |   | |   +-----------+     | | |   |       |   |         | |   |       +---|-------------|-----------|-------------|-----------|-|---|---------+     |   |   |     | |     |       | | | | |   \r\n | | | | |   | |   |   |       |     | | |   |       |   |         | |   |           |   | |   | | | |         |   |     | | |     |     | | | |   |   |       |   |   |     | |     |       | | | | |   \r\n | | | | | +-|-----+   |       |     | | |   |       |   |     +---------------------|---|-|---|-|---|-------------|-----|---|-----|-------|-|-|---------------|---------------|-----------------|---+   \r\n | | | | | | | |       |       |     | | |   |       |   |     |   | |   |           |   | |   | | | |         |   |     | | |     |     | | | |   |   |       |   |   |     | |     |       | | | |     \r\n | | | | | | | |       |       |     | | | +-|-------|---|-----------|---------------+   | +---|-|-+ +-+       |   |     | +-------+   +-+ | | |   |   |       |   | +-------+ |     |       | | | |     \r\n | | | | | | | |       |       |     | | | | |       |   |     |   | |   |               |     | |     |       |   |     |   |         |   | | |   |   |       |   | | |       |     |       | | | |     \r\n | | | | +-|-|-----------------+   +---+ | | |       |   |     +---|-|---|---------------------|-------|-------------------------------|---|-|-----|---|-------|-+ | | |   +---|-----|-+     | | | |     \r\n | | | |   | | |       |           | |   | | |       |   |         | |   |               |     | |     |       |   |     |   |         |   | | |   |   |       | | | | |   |   |     | |     | | | |     \r\n | | | |   | | |       |           +-|-----|---------|-------------|-|-------------------------|-|-------------|-------------|---------|-----|-|---|---|-----+ | +-|-+ |   |   | +---+ |     | | | |     \r\n | | | |   | | |       |             |   | | |       |   |         | |   |               |     | |     |       |   |     |   |         |   | | |   |   |     | |   |   |   |   | |     |     | | | |     \r\n | +-|-|---|-|---------|-------------|---|-----------|---|-----------|-----------------+ |     | |   +-|---------+ |     |   |   +-----|-----|-|---|-----------|---|-------|---|-|-----+     | | | |     \r\n |   | |   | | |       |             |   | | |       |   |         | |   |             | |     | |   | |       | | |     |   |   |     |   | | |   |   |     | |   |   |   |   | |           | | | |     \r\n | +-|-|-+ | | |       |             +-----|-|-------|---------------------------------|-------|-------+       +---------+   +---|-----|---|-|-|---+   |     +---------+   |   | |           | | +-|---+ \r\n | | | | | | | |       |                 | | |       |   |         | |   |             | |     | |   |           | |             |     |   | | |       |       |   |       |   | |           | |   |   | \r\n | +-|-+ +-----|-------------------------|---|-------+   |         | |   |             +---------|-----+         | |       +---------------|---|-------|-------|---|-----------|-------------|-----|---+ \r\n |   |     | | |       |                 | | |           |         | |   |               |     | |   | |         | |       |     |     |   | | |       |       |   |       |   | |           | |   |     \r\n | +---+   | +---------|---------------------|-----------------------|---|---------------|-----|-----------------+ |       | +---------+   | | |       |       |   |       |   | |           | |   |     \r\n | | | |   |   |       |                 | | |           |         | |   |               |     | |   | |           |       | |   |         | | |       |       |   |       |   | |           | |   |     \r\n | +-|-|-------|-------+                 | | +-----------|---------|-|---|-----------------------|-----|-----------|---------|---|---------|---|-------------------|-------------|-----------+ |   |     \r\n |   | |   |   |                         | |             |         | |   |               |     | |   | |           |       | |   |         | | |       |       |   |       |   | |             |   |     \r\n +---+ |   |   |           +-------------+ +-----------------------|-+   |               |   +---|---+ +-----------|-------|-----|-----------|-|-------+       +---|-------+   | +-----------+ |   |     \r\n       |   |   |           |                             |         |     |               |   | | |                 |       | |   |         | | |                   |           |             | |   |     \r\n       +---+   +-----------+                             |         |     +---------------+   +-+ +-----------------+       | |   +-----------|-------------------+ |           |             | |   |     \r\n                                                         |         |                                                       | |             | | |                 | |           |             | |   |     \r\n                                             +-----------|-----------------------------------------------------------------|-|-------------|---|-----------------+ +---+       |             | |   |     \r\n                                             |           |         |                                                       | |             | | |                       |       |             | |   |     \r\n                                             +-----------+         +-------------------------------------------------------+ +---N         +-+ +-----------------------+       +-------------+ +---+     \r\n                                                                                                                                                                                                         \r\n");

			var exampleResult = FollowPath(example);
			Debug.Assert(exampleResult.visitedLetters == "ABCDEF");
			Debug.Assert(exampleResult.stepCount == 38);

			Console.WriteLine(FollowPath(input));

			Console.WriteLine("Done");
			Console.ReadKey();
		}

		static Map ParseInput(string input)
		{
			var lines = input.Split(new char[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
			int width = lines[0].Length;
			int height = lines.Length;

			var map = new Map()
			{
				Grid = new bool[width, height],
				LetterPositions = new Dictionary<(int x, int y), char>(),
			};

			for (int x = 0; x < width; x++)
			{
				for (int y = 0; y < height; y++)
				{
					var c = lines[y][x];
					if (char.IsLetter(c))
					{
						map.LetterPositions[(x, y)] = c;
					}
					map.Grid[x, y] = c != ' ';

					if ((x == 0 || y == 0 || x == width - 1 || y == height - 1) && map.Grid[x, y])
					{
						Debug.Assert(map.StartDirection.Equals((0, 0)));

						var dx = x == 0 ? +1 : x == width - 1 ? -1 : 0;
						var dy = y == 0 ? +1 : y == height - 1 ? -1 : 0;

						map.StartPosition = (x, y);
						map.StartDirection = (dx, dy);
					}
				}
			}

			return map;
		}

		static (string visitedLetters, int stepCount) FollowPath(Map map)
		{
			var (x, y) = map.StartPosition;
			var (dx, dy) = map.StartDirection;
			var stepCount = 1;

			bool IsOnPath(int xx, int yy)
			{
				return xx >= 0 && xx < map.Width
					&& yy >= 0 && yy < map.Height
					&& map.Grid[xx, yy];
			}

			var sb = new StringBuilder();

			while (true)
			{
				if (map.LetterPositions.TryGetValue((x, y), out var letter))
				{
					sb.Append(letter);
				}

				if (!IsOnPath(x + dx, y + dy))
				{
					(dx, dy) = (-dy, dx); // rotate 90°

					if (!IsOnPath(x + dx, y + dy))
					{
						(dx, dy) = (-dx, -dy); // rotate 180°

						if (!IsOnPath(x + dx, y + dy))
						{
							break; // no valid next path found
						}
					}
				}

				x += dx;
				y += dy;
				stepCount++;
			}


			return (sb.ToString(), stepCount);
		}

		class Map
		{
			public int Width => Grid.GetLength(0);
			public int Height => Grid.GetLength(1);
			public bool[,] Grid { get; set; }
			public Dictionary<(int x, int y), char> LetterPositions { get; set; }

			public (int x, int y) StartPosition;
			public (int dx, int dy) StartDirection;
		}

	}
}
